version: "3.9"

networks:
  default:
    name: llm-rag-network
    external: true

services:
  llm-rag-cli:
    image: llm-rag-cli
    container_name: llm-rag-cli
    volumes:
      - ${SECRETS_DIR:-../../secrets}:/secrets
      - .:/app/models
    working_dir: /app/models
    environment:
      GOOGLE_APPLICATION_CREDENTIALS: ${GOOGLE_APPLICATION_CREDENTIALS}
      GCP_PROJECT: $GCP_PROJECT
      # These ensure the client uses the right host and port
      CHROMADB_HOST: llm-rag-chromadb
      CHROMADB_PORT: 8000
    depends_on:
      - chromadb
    restart: always  # ensure CLI auto-restarts if stopped (optional)
    networks:
      - default

  chromadb:
    image: chromadb/chroma:latest   # ✅ Pin to a stable version
    container_name: llm-rag-chromadb
    ports:
      - "8000:8000"
    volumes:
      # persistent local storage so data survives restarts
      # - /home/briannagrissom/llm-rag/models/docker-volumes/chromadb:/data # comment out for relative path
      - ./docker-volumes/chromadb:/data
    environment:
      - IS_PERSISTENT=TRUE
      - ANONYMIZED_TELEMETRY=FALSE
      - CHROMA_CORS_ALLOW_ORIGINS=["*"]
      # Long timeouts to handle big inserts
      - CHROMA_HTTP_TIMEOUT=600
      # optional: increase parallel insert chunk size
      - CHROMA_SERVER_WORKERS=4
    restart: always           # ✅ Restarts automatically on crash or reboot
    networks:
      - default
